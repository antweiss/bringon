version: '1.0'
steps:
  BuildingDockerImage:
    title: Building Docker Image
    type: build
    image_name: otomato/bringon
    working_directory: ./
    dockerfile: Dockerfile
    tag: '${{CF_BRANCH_TAG_NORMALIZED}}'
  PushingToDockerRegistry:
    title: Pushing to Docker Registry
    type: push
    candidate: '${{BuildingDockerImage}}'
    tag: '${{CF_BUILD_ID}}'
    registry: dockerhub
  GetJiraID:
    title: Get Jira ID
    image: alpine:latest
    commands:
      - echo JIRAID=$(echo ${{CF_COMMIT_MESSAGE}} |perl -ple 's/([A-Z]+-\d+).*/\1/') > ${{CF_VOLUME_PATH}}/env_vars_to_export
  UpdatingJira:
    title: Update Jira Issue 
    image: otomato/jira-cli:alpine
    commands:
      - jira-cli update ${JIRAID} --comment "New docker image ${{CF_BUILD_ID}}" --jira-url ${JIRA_URL} -u ${JIRA_USR} -p ${JIRA_PWD}
